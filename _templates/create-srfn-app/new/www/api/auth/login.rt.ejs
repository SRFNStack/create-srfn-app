---
to: "<%=authEnabled ? `${appName}/www/api/auth/login.rt.js` : null%>"
---
const { createToken, hashPassword } = require( '../../../apiAuth.js' )
const { getUser, getUserAuth, patchUserAuth } = require( '../../../lib/userdb.js' )
const max_failedLogins = 10
const auto_unlock_ms = 24 * 60 * 60 * 1000

module.exports = {
    POST: async ( { body: { body } } ) => {
        let { username, password } = JSON.parse( Buffer.from( body, 'base64' ).toString() )
        if( !username || !password ) {
            throw {
                status: 400,
                message: 'Username and Password are required'
            }
        }
        username = username.toLowerCase()

        let user = await getUser(username)
        if( !user ) {
            throw {
                status: 401,
                message: 'Login Failed'
            }
        }

        let userAuth = await getUserAuth(username)
        if( !userAuth ) {
            throw {
                status: 401,
                message: 'Login Failed'
            }
        }

        if( userAuth.lockedAt && new Date().getTime() < userAuth.lockedAt.getTime() + auto_unlock_ms ) {
            throw { status: 401, message: 'User is locked.' }
        }
        if( !userAuth.salt || !userAuth.passwordHash ) {
            //this user has never had a password set
            throw { status: 401, message: 'Login Failed' }
        }

        const incoming = hashPassword( password, userAuth.salt )

        if( incoming !== userAuth.passwordHash ) {
            if( userAuth.failedLogins >= max_failedLogins ) {
                await patchUserAuth({id: userAuth.id, failedLogins: userAuth.failedLogins + 1, lockedAt: new Date()})
                throw { status: 401, message: 'Too many failed attempts, user locked.' }
            } else {
                await patchUserAuth({id: userAuth.id, failedLogins: userAuth.failedLogins + 1})
                throw { status: 401, message: 'Login Failed.' }
            }
        }

        if( userAuth.locked_at || userAuth.failedLogins > 0 ) {
            await patchUserAuth({id: userAuth.id, failedLogins: 0, lockedAt: null})
        }
        return { token: createToken( { sub: username, username<%if ( rolesEnabled ){%>, roles: user.roles<%}%> } ) }
    }
}
